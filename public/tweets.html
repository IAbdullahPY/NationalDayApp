<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tweet Stack (fits 16:9, RTL/LTR auto)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* Page / background */
  html, body { height:100%; margin:0; background:#000; }
  .stage { position:relative; width:100vw; height:100vh; overflow:hidden; display:grid; place-items:center; }
  .bg { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; z-index:0; }

  /* Frame (16:9 safe area) */
  .frame {
    position:absolute; z-index:1;
    left:50%; top:50%; transform:translate(-50%, -50%);
    width: min(100vw, calc(100vh * 16 / 9));
    height: min(100vh, calc(100vw * 9 / 16));
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
  }

  /* Stack of tweets */
  .stack {
    width: min(28%, 360px);  /* wider tweets */
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 40px;
  }

  /* Tweet bubble */
  .tweet {
    position: relative;
    background: url("assets/bubble.gif") center/cover no-repeat;
    color: #ffffff;
    border-radius: 18px;
    padding: 14px 28px 12px 20px; /* balanced padding */
    box-shadow: 0 10px 28px rgba(0,0,0,.28);
    min-height: 64px;
    opacity: 0;
    transform: translateY(22px);
    transition: opacity .5s ease, transform .5s ease;
    font-size: 0.9em;
    max-width: 100%;
  }

  /* Show bubbles */
  .tweet.show { 
    opacity: 1; 
    transform: translateY(0); 
  }

  /* Name */
.name {
  position:absolute;
  top:8px;
  left:16px;
  right:16px;   /* allow it to align on both sides */
  font-weight:700;
  font-size:14px;
  color:#fff;
}

  /* Text */
  .text {
    margin-top:26px;
    font-size:18px; line-height:1.42; font-weight:600;
    word-break:break-word;
  }

  /* Peek wrapper */
  .peek-wrap {
    position: relative;
    margin-top: -4px;
    overflow: hidden;
  }

  /* The faded 4th tweet (peek) */
  .tweet.peek {
    opacity: .42;
    transform: translateY(8px) scale(.985);
  }

  /* Exit animation */
  @keyframes slideOut { to { opacity:0; transform:translateY(-22px); } }
  .anim-out { animation:slideOut .38s ease forwards; }
</style>
</head>
<body>
  <div class="stage">
    <img class="bg" src="assets/background.jpg" alt="bg" />
    <div class="frame">
      <div class="stack" id="stack"></div>
    </div>
  </div>

<script>
  let messages = [];
  let head = 0;

  // Detect if text is Arabic
  function isArabic(s) {
    return /[\u0600-\u06FF]/.test(s || "");
  }

  // Fetch all messages (oldest â†’ newest)
  async function fetchAll() {
    const res = await fetch('/api/messages');
    const data = await res.json();
    messages = data.map(x => ({
      name: x.name ?? "",
      text: x.message ?? ""
    }));
    if (!messages.length) {
      messages = [{ name: "", text: "Waiting for messagesâ€¦" }];
    }
  }

  // Create tweet bubble
function bubble(item, extraClass = "") {
  const el = document.createElement('div');
  el.className = `tweet ${extraClass}`;
  const dir = isArabic(item.text) ? 'rtl' : 'ltr';
  el.innerHTML = `
    <div class="name" style="direction:${dir}; text-align:${dir==='rtl'?'right':'left'};">
      ${item.name || ""}
    </div>
    <div class="text" style="direction:${dir}; text-align:${dir==='rtl'?'right':'left'};">
      ${item.text || ""}
    </div>
  `;
  return el;
}

  // Render 3 tweets + peek
function render() {
  const stack = document.getElementById('stack');
  stack.innerHTML = "";

  if (!messages.length) return;

  // Main 3 (or fewer if not enough messages)
  const a = messages[(head + 0) % messages.length];
  const b = messages.length > 1 ? messages[(head + 1) % messages.length] : a;
  const c = messages.length > 2 ? messages[(head + 2) % messages.length] : b;

  const t1 = bubble(a); t1.classList.add('show');
  const t2 = bubble(b); t2.classList.add('show');
  const t3 = bubble(c); t3.classList.add('show');

  stack.appendChild(t1);
  stack.appendChild(t2);
  stack.appendChild(t3);

  // ðŸ‘‰ Force 4th peek (even if only duplicates)
  let p;
  if (messages.length > 3) {
    p = messages[(head + 3) % messages.length];
  } else {
    // repeat the last available message as peek
    p = messages[messages.length - 1];
  }

  const wrap = document.createElement('div');
  wrap.className = 'peek-wrap';
  const peek = bubble(p, 'peek show');
  wrap.appendChild(peek);
  stack.appendChild(wrap);
}

  // Rotate every 10s
  function tick() {
    document.querySelectorAll('.tweet:not(.peek)').forEach(n => n.classList.add('anim-out'));
    setTimeout(() => {
      head = (head + 3) % messages.length;
      render();
    }, 380); // match CSS anim
  }

  // Start loop
  async function start() {
    await fetchAll();
    // show the last 3 first
    if (messages.length > 3) {
      head = messages.length - 3;
    }
    render();

    // Cycle every 10s
    setInterval(() => {
      tick();
    }, 10000);

    // Refresh DB every 10s
    setInterval(async () => {
      await fetchAll();
    }, 10000);
  }

  start();
</script>
</body>
</html>