<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tweet Stack (Responsive)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* Page / background */
  html, body { height:100%; margin:0; background:#000; }
  .stage { position:relative; width:100vw; height:100vh; overflow:hidden; display:grid; place-items:center; }
  .bg { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; z-index:0; }

  /* Frame */
  .frame {
    position: absolute; 
    z-index: 1;
    left: 50%; 
    top: 50%; 
    transform: translate(-50%, -50%);
    display: flex; 
    align-items: center; 
    justify-content: center;
    pointer-events: none;
    width: 100vw;
    height: 100vh;
  }

  /* Default (mobile & vertical screens) */
  .stack {
    width: 85vw;
    max-width: 750px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 15vh;
  }

  .tweet {
    position: relative;
    background: url("assets/bubble.gif") center/cover no-repeat;
    color: #ffffff;
    border-radius: 18px;
    padding: 2vh 2vw;
    box-shadow: 0 10px 28px rgba(0,0,0,.28);
    min-height: 10vh;
    opacity: 0;
    transform: translateY(22px);
    transition: opacity .5s ease, transform .5s ease;
    font-size: 2vh;
    max-width: 100%;
  }

  /* Laptops / wide screens */
  @media (min-aspect-ratio: 16/10) {
    .stack {
      width: 25vw;
      max-width: 380px;
    }
    .tweet {
      font-size: 1.2em;
      min-height: 80px;
      padding: 16px 20px;
    }
  }

  /* Show bubbles */
  .tweet.show { 
    opacity: 1; 
    transform: translateY(0); 
  }

  /* Name */
  .name {
    position:absolute;
    top:8px;
    left:16px;
    right:16px;
    font-weight:700;
    font-size:14px;
    color:#fff;
  }

  /* Text */
  .text {
    margin-top:26px;
    font-size:18px; 
    line-height:1.42; 
    font-weight:600;
    word-break:break-word;
  }

  /* Exit animation */
  @keyframes slideOut { to { opacity:0; transform:translateY(-22px); } }
  .anim-out { animation:slideOut .38s ease forwards; }

  /* Large vertical screen (e.g. 1080x1920) */
  @media (min-height: 1500px) and (max-width: 1200px) {
    .stack {
      width: 95%;
      max-width: 1100px;
      gap: 30px;
    }
    .tweet {
      font-size: 1.4em;
      min-height: 140px;
      padding: 24px 32px;
    }
  }
</style>
</head>
<body>
  <div class="stage">
    <img class="bg" src="assets/background.jpg" alt="bg" />
    <div class="frame">
      <div class="stack" id="stack"></div>
    </div>
  </div>

<script>
  let messages = [];
  let head = 0;

  // Detect if text is Arabic
  function isArabic(s) {
    return /[\u0600-\u06FF]/.test(s || "");
  }

  // Fetch all messages
  async function fetchAll() {
    const res = await fetch('/api/messages');
    const data = await res.json();
    messages = data.map(x => ({
      name: x.name ?? "",
      text: x.message ?? ""
    }));
    if (!messages.length) {
      messages = [{ name: "", text: "Waiting for messagesâ€¦" }];
    }
  }

  // Create tweet bubble
  function bubble(item, extraClass = "") {
    const el = document.createElement('div');
    el.className = `tweet ${extraClass}`;
    const dir = isArabic(item.text) ? 'rtl' : 'ltr';
    el.innerHTML = `
      <div class="name" style="direction:${dir}; text-align:${dir==='rtl'?'right':'left'};">
        ${item.name || ""}
      </div>
      <div class="text" style="direction:${dir}; text-align:${dir==='rtl'?'right':'left'};">
        ${item.text || ""}
      </div>
    `;
    return el;
  }

  // Render 4 tweets
  function render() {
    const stack = document.getElementById('stack');
    stack.innerHTML = "";

    if (!messages.length) return;

    const a = messages[(head + 0) % messages.length];
    const b = messages.length > 1 ? messages[(head + 1) % messages.length] : a;
    const c = messages.length > 2 ? messages[(head + 2) % messages.length] : b;
    const d = messages.length > 3 ? messages[(head + 3) % messages.length] : c;

    const t1 = bubble(a); t1.classList.add('show');
    const t2 = bubble(b); t2.classList.add('show');
    const t3 = bubble(c); t3.classList.add('show');
    const t4 = bubble(d); t4.classList.add('show');

    stack.appendChild(t1);
    stack.appendChild(t2);
    stack.appendChild(t3);
    stack.appendChild(t4);
  }

  // Rotate every 10s
  function tick() {
    document.querySelectorAll('.tweet').forEach(n => n.classList.add('anim-out'));
    setTimeout(() => {
      head = (head + 4) % messages.length;
      render();
    }, 380); 
  }

  // Start loop
  async function start() {
    await fetchAll();
    if (messages.length > 4) {
      head = messages.length - 4;
    }
    render();

    setInterval(() => {
      tick();
    }, 10000);

    setInterval(async () => {
      await fetchAll();
    }, 10000);
  }

  start();
</script>
</body>
</html>