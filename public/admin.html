<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</title>
  <style>
    @font-face {
  font-family: 'Saudi';
  src: url('assets/fonts/SaudiRegular.otf') format('truetype');
}

body {
}
    body {
  font-family: 'Saudi', sans-serif;
      margin: 15px;
      background: url("assets/plain.png") no-repeat center center fixed;
      background-size: cover;
      color: #333;
    }
    h1 {
      margin-bottom: 20px;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);

      font-size: 28px;    
      text-align: center; 
    }
    div {
      text-align: center; 
      margin-bottom: 15px;
    }
    button {
      padding: 8px 16px;  
      margin: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;   
    }
    .delete-btn {
      background: #e74c3c;
      color: #fff;
    }
    .clear-btn {
      background: #c0392b;
      color: #fff;
    }
    .refresh-btn {
      background: #27ae60;
      color: #fff;
    }
    .export-btn {
      background: #2980b9;
      color: #fff;
    }

table {
  width: 1000px;              
  height: 550px;         
  margin: 0 auto;            
  display: block;           
  overflow: auto;          
  border-collapse: collapse;
  background: rgba(255,255,255,0.95);
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 15px;
  table-layout: auto;      
}
    th, td {
      padding: 12px;      
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #333;
      color: #fff;
      font-size: 16px;  
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ·Ù†ÙŠ</h1>
  <div>
    <button class="refresh-btn" onclick="loadMessages()">ğŸ”„ Ø­Ø¯Ø« Ø§Ù„ØµÙØ­Ø©</button>
    <button class="clear-btn" onclick="clearMessages()">ğŸ—‘ Ø§Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„</button>
    <button class="export-btn" onclick="exportCSV()">â¬‡ ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù</button>
  </div>
  <br>
<table id="msgTable">
  <colgroup>
    <col style="width: 8%">   <!-- ID -->
    <col style="width: 18%">  <!-- Name -->
    <col style="width: 48%">  <!-- Message -->
    <col style="width: 20%">  <!-- Created At -->
    <col style="width: 6%">   <!-- Action -->
  </colgroup>
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Message</th>
      <th>Created At</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  <script>
    fetch('/api/admin/messages')
      .then(res => {
        if (res.status === 403) {
          window.location.href = "/login.html";
        }
      });

   async function loadMessages() {
  const res = await fetch('/api/admin/messages');
  const data = await res.json();
  const tbody = document.querySelector("#msgTable tbody");
  tbody.innerHTML = "";
  data.forEach((msg, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${msg.name}</td>
      <td>${msg.message}</td>
      <td>${msg.created_at}</td>
      <td><button class="delete-btn" onclick="deleteMessage(${msg.id})">Ø­Ø°Ù</button></td>
    `;
    tbody.appendChild(tr);
  });
}

    async function deleteMessage(id) {
      if (!confirm("Delete this message?")) return;
      await fetch('/api/admin/messages/' + id, { method: 'DELETE' });
      loadMessages();
    }

    async function clearMessages() {
      if (!confirm("Delete ALL messages?")) return;
      await fetch('/api/admin/messages', { method: 'DELETE' });
      loadMessages();
    }

    async function exportCSV() {
      const res = await fetch('/api/admin/messages');
      const data = await res.json();
      let csv = "ID,Name,Message,Created At\n";
      data.forEach(m => {
        csv += `"${m.id}","${m.name}","${m.message.replace(/"/g,'""')}","${m.created_at}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "messages.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    loadMessages();
    setInterval(loadMessages, 1000);
  </script>
</body>
</html>